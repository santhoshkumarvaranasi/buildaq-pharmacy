<div class="medicine-detection-container">
  <mat-card class="detection-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>local_pharmacy</mat-icon>
        Medicine Detection & Placement
      </mat-card-title>
      <mat-card-subtitle>Detect medicines from images and map them to shelf locations</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Detection Settings -->
      <mat-accordion class="settings-accordion">
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>settings</mat-icon>
              Detection Settings
            </mat-panel-title>
          </mat-expansion-panel-header>

          <form [formGroup]="form" class="settings-form">
            <mat-form-field appearance="fill" class="full-width">
              <mat-label>Image URL</mat-label>
              <input matInput formControlName="imageUrl" placeholder="Enter image URL">
              <mat-error *ngIf="form.get('imageUrl')?.hasError('required')">
                Image URL is required
              </mat-error>
            </mat-form-field>

            <div class="form-row">
              <mat-form-field appearance="fill">
                <mat-label>Min Confidence</mat-label>
                <input matInput type="number" formControlName="minConfidence" min="0" max="1" step="0.1">
                <mat-hint>0.0 - 1.0</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="fill">
                <mat-label>Filter by Class</mat-label>
                <input matInput formControlName="filterClass" placeholder="e.g., bottle, box">
              </mat-form-field>
            </div>

            <button mat-raised-button color="primary" (click)="detectFromUrl()" [disabled]="isLoading">
              <mat-icon>search</mat-icon>
              {{ isLoading ? 'Detecting...' : 'Detect Medicines' }}
            </button>

            <button mat-button (click)="filterDetections()" [disabled]="!detectionResult">
              <mat-icon>filter_list</mat-icon>
              Apply Filters
            </button>
          </form>
        </mat-expansion-panel>
      </mat-accordion>

      <!-- Current Shelf Info -->
      <div *ngIf="selectedShelf" class="shelf-info">
        <mat-icon>info</mat-icon>
        <div>
          <strong>Current Shelf:</strong> {{ selectedShelf.name }} ({{ selectedShelf.width }} x {{ selectedShelf.height }} cm)
        </div>
      </div>

      <div *ngIf="!selectedShelf" class="warning-info">
        <mat-icon>warning</mat-icon>
        <div>
          <strong>No shelf selected.</strong> Please select a shelf from the Visual Space Mapper to add detected medicines.
        </div>
      </div>

      <!-- Detected Medicines Table -->
      <div class="detected-medicines-section">
        <h3>Detected Medicines ({{ detectedMedicines.length }})</h3>

        <div *ngIf="detectedMedicines.length === 0" class="empty-state">
          <mat-icon>inventory_2</mat-icon>
          <p>No medicines detected yet. Upload an image to start detection.</p>
        </div>

        <mat-table [dataSource]="detectedMedicines" *ngIf="detectedMedicines.length > 0" class="medicines-table">
          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <mat-header-cell *matHeaderCellDef>Medicine Name</mat-header-cell>
            <mat-cell *matCellDef="let element">
              <strong>{{ element.name }}</strong>
            </mat-cell>
          </ng-container>

          <!-- Class Column -->
          <ng-container matColumnDef="class">
            <mat-header-cell *matHeaderCellDef>Class</mat-header-cell>
            <mat-cell *matCellDef="let element">
              <mat-chip-set aria-label="Class">
                <mat-chip selected>{{ element.name }}</mat-chip>
              </mat-chip-set>
            </mat-cell>
          </ng-container>

          <!-- Confidence Column -->
          <ng-container matColumnDef="confidence">
            <mat-header-cell *matHeaderCellDef>Confidence</mat-header-cell>
            <mat-cell *matCellDef="let element">
              <mat-progress-bar
                mode="determinate"
                [value]="element.confidence * 100"
                class="confidence-bar"
              ></mat-progress-bar>
              {{ (element.confidence * 100).toFixed(1) }}%
            </mat-cell>
          </ng-container>

          <!-- Position Column -->
          <ng-container matColumnDef="position">
            <mat-header-cell *matHeaderCellDef>Position</mat-header-cell>
            <mat-cell *matCellDef="let element">
              <div class="position-display">
                <span>X: {{ element.x }}</span>
                <span>Y: {{ element.y }}</span>
              </div>
            </mat-cell>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
            <mat-cell *matCellDef="let element">
              <button
                mat-icon-button
                [disabled]="!selectedShelf"
                (click)="addMedicineToShelf(element)"
                matTooltip="Add to shelf"
                color="accent"
              >
                <mat-icon>add_location_alt</mat-icon>
              </button>
              <button
                mat-icon-button
                (click)="removeMedicine(element.id)"
                matTooltip="Remove"
                color="warn"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </mat-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
          <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
        </mat-table>
      </div>

      <!-- Detection Result Summary -->
      <div *ngIf="detectionResult" class="detection-summary">
        <h3>Detection Summary</h3>
        <mat-card class="summary-card">
          <mat-card-content>
            <div class="summary-row">
              <span>Total Objects Detected:</span>
              <strong>{{ detectionResult.objects.length }}</strong>
            </div>
            <div class="summary-row">
              <span>Image Dimensions:</span>
              <strong>{{ detectionResult.imageWidth }} x {{ detectionResult.imageHeight }} px</strong>
            </div>
            <div class="summary-row">
              <span>Detection Time:</span>
              <strong>{{ detectionResult.timestamp | date:'short' }}</strong>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<div class="visual-mapper">
  <div class="toolbar">
    <div class="tool-group">
      <button type="button" mat-stroked-button [color]="mode === 'drawWall' ? 'primary' : ''" (click)="setMode('drawWall')">
        Draw Wall
      </button>
      <button type="button" mat-stroked-button [color]="mode === 'drawShelf' ? 'primary' : ''" (click)="setMode('drawShelf')">
        Draw Shelf
      </button>
      <button type="button" mat-stroked-button [color]="mode === 'drawBox' ? 'primary' : ''" (click)="setMode('drawBox')">
        Draw Box
      </button>
      <button type="button" mat-stroked-button [color]="mode === 'select' ? 'primary' : ''" (click)="setMode('select')">
        Select
      </button>
      <button type="button" mat-stroked-button [color]="mode === 'delete' ? 'warn' : ''" (click)="setMode('delete')">
        Delete
      </button>
    </div>
    <div class="tool-group color-picker">
      <label>
        Color
        <input
          type="color"
          *ngIf="mode === 'drawWall'"
          [(ngModel)]="wallColor"
        />
        <input
          type="color"
          *ngIf="mode === 'drawShelf'"
          [(ngModel)]="shelfColor"
        />
        <input
          type="color"
          *ngIf="mode === 'drawBox'"
          [(ngModel)]="boxColor"
        />
      </label>
    </div>
    <div class="tool-group">
      <button type="button" mat-stroked-button [color]="transformMode === 'translate' ? 'accent' : ''" (click)="setTransformMode('translate')">
        Move
      </button>
      <button type="button" mat-stroked-button [color]="transformMode === 'rotate' ? 'accent' : ''" (click)="setTransformMode('rotate')">
        Rotate
      </button>
      <button type="button" mat-stroked-button [color]="transformMode === 'scale' ? 'accent' : ''" (click)="setTransformMode('scale')">
        Scale
      </button>
    </div>
    <div class="tool-group">
      <button type="button" mat-stroked-button color="warn" (click)="clearLayout()">
        Clear Layout
      </button>
    </div>
    <div class="tool-group">
      <label class="preset-label">
        Preset
        <select [(ngModel)]="selectedPresetId">
          <option value="">Choose...</option>
          <option *ngFor="let preset of presets" [value]="preset.id">{{ preset.name }}</option>
        </select>
      </label>
      <button type="button" mat-stroked-button (click)="applyPreset()" [disabled]="!selectedPresetId">
        Import
      </button>
    </div>
  </div>

  <div class="viewport">
    <canvas #sceneCanvas class="scene-canvas"></canvas>
    <div class="hint">
      <div>Wall: click-drag on floor</div>
      <div>Shelf: click-drag on a wall</div>
      <div>Box: click-drag on a shelf</div>
    </div>
    <div
      class="context-menu"
      *ngIf="contextMenu.visible"
      [style.left.px]="contextMenu.x"
      [style.top.px]="contextMenu.y"
      (click)="$event.stopPropagation()"
    >
      <button type="button" (click)="renameSelectedBox()">Rename</button>
      <button type="button" (click)="addMedicineToSelectedBox()">Add Medicine</button>
      <button type="button" (click)="withdrawMedicineFromSelectedBox()">Withdraw Medicine</button>
      <button type="button" (click)="setCapacityForSelectedBox()">Set Capacity</button>
      <button type="button" (click)="viewMedicinesInSelectedBox()">View Medicines</button>
    </div>
    <div class="modal-backdrop" *ngIf="medicinePopup.visible" (click)="closeMedicinePopup()"></div>
    <div class="medicine-modal" *ngIf="medicinePopup.visible">
      <div class="medicine-modal-header">
        <div class="medicine-modal-title">
          {{ medicinePopup.boxName }} Medicines
          <span *ngIf="medicinePopup.capacity > 0" class="capacity-tag">
            Capacity {{ medicinePopup.capacity }}
          </span>
        </div>
        <button type="button" class="close-btn" (click)="cancelMedicinePopup()">Cancel</button>
      </div>
      <div class="medicine-modal-actions">
        <label>
          Box Name
          <input type="text" [(ngModel)]="medicineForm.name" />
        </label>
        <label>
          Tag
          <input type="text" [(ngModel)]="medicineForm.tag" />
        </label>
        <label>
          Capacity
          <input type="number" min="0" [(ngModel)]="medicineForm.capacity" />
        </label>
        <label>
          Min Stock
          <input type="number" min="0" [(ngModel)]="medicineForm.minStock" />
        </label>
        <label>
          Max Stock
          <input type="number" min="0" [(ngModel)]="medicineForm.maxStock" />
        </label>
        <div class="medicine-qty-group">
          <label class="medicine-field">
            Medicine
            <input type="text" [(ngModel)]="medicineForm.medicineName" />
          </label>
          <label class="qty-field">
            Qty
            <div class="qty-row">
              <div class="qty-input">
                <button type="button" (click)="updateQuantity(-1)">-</button>
                <input type="number" min="1" [(ngModel)]="medicineForm.quantity" />
                <button type="button" (click)="updateQuantity(1)">+</button>
              </div>
              <div class="mode-toggle">
                <button type="button" [class.active]="medicineForm.mode === 'deposit'" (click)="medicineForm.mode='deposit'">Deposit</button>
                <button type="button" [class.active]="medicineForm.mode === 'withdraw'" (click)="medicineForm.mode='withdraw'">Withdraw</button>
              </div>
            </div>
          </label>
        </div>
      </div>
      <div class="action-row">
        <button type="button" (click)="cancelMedicinePopup()">Cancel</button>
        <button type="button" class="save-btn" (click)="saveMedicinePopup()">Save</button>
      </div>
      <div class="medicine-modal-body">
        <div
          class="medicine-row"
          *ngFor="let med of medicinePopup.medicines"
          (click)="selectMedicine(med.name)"
          [class.active]="medicineForm.medicineName === med.name"
        >
          <span class="medicine-name">{{ med.name }}</span>
          <span class="medicine-qty" [class.negative]="med.qty < 0">{{ med.qty }}</span>
          <span class="medicine-alert" *ngIf="med.qty < 0">short {{ -med.qty }}</span>
        </div>
      </div>
    </div>
    <div class="direction-compass" aria-label="Direction compass">
      <div class="compass-ring"></div>
      <div class="compass-label north">N</div>
      <div class="compass-label east">E</div>
      <div class="compass-label south">S</div>
      <div class="compass-label west">W</div>
    </div>
  </div>
</div>

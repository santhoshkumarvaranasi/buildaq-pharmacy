<div class="visual-mapper">
  <div class="toolbar">
    <div class="tool-group">
      <button type="button" mat-stroked-button [color]="mode === 'drawWall' ? 'primary' : ''" (click)="setMode('drawWall')">
        Draw Wall
      </button>
      <button type="button" mat-stroked-button [color]="mode === 'drawShelf' ? 'primary' : ''" (click)="setMode('drawShelf')">
        Draw Shelf
      </button>
      <button type="button" mat-stroked-button [color]="mode === 'drawBox' ? 'primary' : ''" (click)="setMode('drawBox')">
        Draw Box
      </button>
      <button type="button" mat-stroked-button [color]="mode === 'select' ? 'primary' : ''" (click)="setMode('select')">
        Select
      </button>
      <button type="button" mat-stroked-button [color]="mode === 'delete' ? 'warn' : ''" (click)="setMode('delete')">
        Delete
      </button>
    </div>
    <div class="tool-group color-picker">
      <label>
        Color
        <input
          type="color"
          *ngIf="mode === 'drawWall'"
          [(ngModel)]="wallColor"
        />
        <input
          type="color"
          *ngIf="mode === 'drawShelf'"
          [(ngModel)]="shelfColor"
        />
        <input
          type="color"
          *ngIf="mode === 'drawBox'"
          [(ngModel)]="boxColor"
        />
      </label>
    </div>
    <div class="tool-group">
      <button type="button" mat-stroked-button [color]="transformMode === 'translate' ? 'accent' : ''" (click)="setTransformMode('translate')">
        Move
      </button>
      <button type="button" mat-stroked-button [color]="transformMode === 'rotate' ? 'accent' : ''" (click)="setTransformMode('rotate')">
        Rotate
      </button>
      <button type="button" mat-stroked-button [color]="transformMode === 'scale' ? 'accent' : ''" (click)="setTransformMode('scale')">
        Scale
      </button>
    </div>
    <div class="tool-group">
      <button type="button" mat-stroked-button color="warn" (click)="clearLayout()">
        Clear Layout
      </button>
    </div>
    <div class="tool-group">
      <button type="button" mat-stroked-button color="primary" (click)="openPicklist()">
        Picklist
      </button>
    </div>
    <div class="tool-group">
      <button type="button" mat-stroked-button color="primary" (click)="openBatchLabel()">
        Batch Label ({{ selectedBoxIds.length }})
      </button>
    </div>
    <div class="tool-group">
      <button type="button" mat-stroked-button [color]="shelfCapacityEnabled ? 'accent' : ''" (click)="toggleShelfCapacity()">
        Shelf Capacity
      </button>
    </div>
    <div class="tool-group">
      <button type="button" mat-stroked-button [color]="zonePickerEnabled ? 'accent' : ''" (click)="toggleZonePicker()">
        Zone Picker
      </button>
      <button type="button" mat-stroked-button *ngIf="activeZoneTag" (click)="clearZoneFilter()">
        Clear Zone
      </button>
      <span class="zone-chip" *ngIf="activeZoneTag">{{ activeZoneTag }}</span>
    </div>
    <div class="tool-group">
      <button type="button" mat-stroked-button [color]="heatmapEnabled ? 'accent' : ''" (click)="toggleHeatmap()">
        Heatmap
      </button>
    </div>
    <div class="tool-group">
      <button type="button" mat-stroked-button color="primary" (click)="openAudit()">
        Audit
      </button>
    </div>
    <div class="tool-group">
      <button type="button" mat-stroked-button color="primary" (click)="openRestock()">
        Restock
      </button>
    </div>
    <div class="tool-group">
      <label class="preset-label">
        Preset
        <select [(ngModel)]="selectedPresetId">
          <option value="">Choose...</option>
          <option *ngFor="let preset of presets" [value]="preset.id">{{ preset.name }}</option>
        </select>
      </label>
      <button type="button" mat-stroked-button (click)="applyPreset()" [disabled]="!selectedPresetId">
        Import
      </button>
    </div>
  </div>

  <div class="viewport">
    <canvas #sceneCanvas class="scene-canvas"></canvas>
    <div class="hint">
      <div>Wall: click-drag on floor</div>
      <div>Shelf: click-drag on a wall</div>
      <div>Box: click-drag on a shelf</div>
    </div>
    <div
      class="context-menu"
      *ngIf="contextMenu.visible"
      [style.left.px]="contextMenu.x"
      [style.top.px]="contextMenu.y"
      (click)="$event.stopPropagation()"
    >
      <button type="button" (click)="renameSelectedBox()">Rename</button>
      <button type="button" (click)="addMedicineToSelectedBox()">Add Medicine</button>
      <button type="button" (click)="withdrawMedicineFromSelectedBox()">Withdraw Medicine</button>
      <button type="button" (click)="setCapacityForSelectedBox()">Set Capacity</button>
      <button type="button" (click)="viewMedicinesInSelectedBox()">View Medicines</button>
    </div>
    <div class="modal-backdrop" *ngIf="medicinePopup.visible || batchLabelOpen" (click)="closeMedicinePopup(); closeBatchLabel()"></div>
    <div class="medicine-modal" *ngIf="medicinePopup.visible">
      <div class="medicine-modal-header">
        <div class="medicine-modal-title">
          {{ medicinePopup.boxName }} Medicines
          <span *ngIf="medicinePopup.capacity > 0" class="capacity-tag">
            Capacity {{ medicinePopup.capacity }}
          </span>
        </div>
        <button type="button" class="close-btn" (click)="cancelMedicinePopup()">Cancel</button>
      </div>
      <div class="medicine-modal-actions">
        <label>
          Box Name
          <input type="text" [(ngModel)]="medicineForm.name" />
        </label>
        <label>
          Tag
          <input type="text" [(ngModel)]="medicineForm.tag" />
        </label>
        <label>
          Capacity
          <input type="number" min="0" [(ngModel)]="medicineForm.capacity" />
        </label>
        <label>
          Min Stock
          <input type="number" min="0" [(ngModel)]="medicineForm.minStock" />
        </label>
        <label>
          Max Stock
          <input type="number" min="0" [(ngModel)]="medicineForm.maxStock" />
        </label>
        <div class="medicine-qty-group">
          <label class="medicine-field">
            Medicine
            <input type="text" [(ngModel)]="medicineForm.medicineName" />
          </label>
          <label class="qty-field">
            Qty
            <div class="qty-row">
              <div class="qty-input">
                <button type="button" (click)="updateQuantity(-1)">-</button>
                <input type="number" min="1" [(ngModel)]="medicineForm.quantity" />
                <button type="button" (click)="updateQuantity(1)">+</button>
              </div>
              <div class="mode-toggle">
                <button type="button" [class.active]="medicineForm.mode === 'deposit'" (click)="medicineForm.mode='deposit'">Deposit</button>
                <button type="button" [class.active]="medicineForm.mode === 'withdraw'" (click)="medicineForm.mode='withdraw'">Withdraw</button>
              </div>
            </div>
          </label>
        </div>
      </div>
      <div class="action-row">
        <button type="button" (click)="cancelMedicinePopup()">Cancel</button>
        <button type="button" class="save-btn" (click)="saveMedicinePopup()">Save</button>
      </div>
      <div class="medicine-modal-body">
        <div
          class="medicine-row"
          *ngFor="let med of medicinePopup.medicines"
          (click)="selectMedicine(med.name)"
          [class.active]="medicineForm.medicineName === med.name"
        >
          <span class="medicine-name">{{ med.name }}</span>
          <span class="medicine-qty" [class.negative]="med.qty < 0">{{ med.qty }}</span>
          <span class="medicine-alert" *ngIf="med.qty < 0">short {{ -med.qty }}</span>
        </div>
      </div>
    </div>
    <div class="batch-label-modal" *ngIf="batchLabelOpen">
      <div class="batch-label-header">
        <div>
          <div class="batch-label-title">Batch Label Boxes</div>
          <div class="batch-label-subtitle">{{ selectedBoxIds.length }} boxes selected</div>
        </div>
        <button type="button" class="close-btn" (click)="closeBatchLabel()">Cancel</button>
      </div>
      <div class="batch-label-body">
        <label>
          Prefix
          <input type="text" maxlength="4" [(ngModel)]="batchLabelForm.prefix" />
        </label>
        <label>
          Start #
          <input type="number" min="1" [(ngModel)]="batchLabelForm.start" />
        </label>
        <label>
          Tag
          <input type="text" [(ngModel)]="batchLabelForm.tag" />
        </label>
      </div>
      <div class="action-row">
        <button type="button" (click)="closeBatchLabel()">Cancel</button>
        <button type="button" class="save-btn" (click)="applyBatchLabel()">Apply</button>
      </div>
    </div>
    <div class="picklist-drawer" *ngIf="picklistOpen">
      <div class="picklist-header">
        <div>
          <div class="picklist-title">Picklist</div>
          <div class="picklist-subtitle">Select products and guide picking</div>
        </div>
        <button type="button" class="close-btn" (click)="closePicklist()">Close</button>
      </div>
      <div class="picklist-body">
        <div class="picklist-catalog">
          <label class="picklist-search">
            Search
            <input type="text" [(ngModel)]="picklistSearch" placeholder="Search products" />
          </label>
          <div class="picklist-catalog-list">
            <div class="picklist-row" *ngFor="let product of filteredCatalog">
              <div class="picklist-info">
                <div class="picklist-name">{{ product.name }}</div>
                <div class="picklist-meta">{{ product.category }} · stock {{ product.quantity }}</div>
              </div>
              <input
                type="number"
                min="1"
                class="picklist-qty"
                [ngModel]="getPickQty(product.id)"
                (ngModelChange)="setPickQty(product.id, $event)"
              />
              <button type="button" class="picklist-add" (click)="addToPicklist(product)">Add</button>
            </div>
            <div class="picklist-empty" *ngIf="filteredCatalog.length === 0">
              No products found.
            </div>
          </div>
        </div>
        <div class="picklist-items">
          <div class="picklist-actions">
            <button type="button" class="picklist-start" (click)="startPicklist()" [disabled]="picklistItems.length === 0">
              Start Picking
            </button>
            <button type="button" (click)="clearPicklist()" [disabled]="picklistItems.length === 0">Clear</button>
          </div>
          <div class="picklist-item" *ngFor="let item of picklistItems" [class.active]="item.id === picklistCurrentId" [class.picked]="item.status === 'picked'" (click)="focusPickItem(item)">
            <div class="picklist-item-info">
              <div class="picklist-item-name">{{ item.name }}</div>
              <div class="picklist-item-meta">{{ item.tag || 'General' }} · qty {{ item.qty }}</div>
            </div>
            <button type="button" class="picklist-toggle" (click)="togglePicked(item); $event.stopPropagation()">
              {{ item.status === 'picked' ? 'Undo' : 'Picked' }}
            </button>
          </div>
          <div class="picklist-empty" *ngIf="picklistItems.length === 0">
            No items yet. Add products on the left.
          </div>
        </div>
      </div>
    </div>
    <div class="audit-drawer" *ngIf="auditOpen">
      <div class="audit-header">
        <div>
          <div class="audit-title">Stock Audit</div>
          <div class="audit-subtitle">{{ auditTargetName }}</div>
        </div>
        <button type="button" class="close-btn" (click)="closeAudit()">Close</button>
      </div>
      <div class="audit-body">
        <p class="audit-hint">
          Click a shelf or box in the scene to set the audit target, then paste scanned counts.
        </p>
        <label class="audit-label">
          Scanned list (one per line, e.g. "Paracetamol, 12")
          <textarea [(ngModel)]="auditInput" rows="6" placeholder="Medicine Name, qty"></textarea>
        </label>
        <div class="audit-actions">
          <button type="button" (click)="clearAuditInput()">Clear</button>
          <button type="button" class="audit-run" (click)="runAudit()" [disabled]="auditTargetIds.length === 0">Compare</button>
        </div>
        <div class="audit-actions">
          <button type="button" (click)="copyAuditReport()" [disabled]="auditResults.length === 0">Copy Report</button>
          <button type="button" (click)="downloadAuditReport()" [disabled]="auditResults.length === 0">Download Report</button>
        </div>
        <div class="audit-summary" *ngIf="auditResults.length > 0">
          <span>Matched {{ auditSummary.matched }}</span>
          <span>Missing {{ auditSummary.missing }}</span>
          <span>Extra {{ auditSummary.extra }}</span>
        </div>
        <div class="audit-results">
          <div class="audit-row" *ngFor="let result of auditResults" [class.missing]="result.status === 'missing'" [class.extra]="result.status === 'extra'">
            <div class="audit-name">{{ result.name }}</div>
            <div class="audit-values">
              <span>Expected {{ result.expected }}</span>
              <span>Scanned {{ result.scanned }}</span>
              <span>Diff {{ result.diff }}</span>
            </div>
          </div>
          <div class="audit-empty" *ngIf="auditResults.length === 0">
            No audit results yet.
          </div>
        </div>
      </div>
    </div>
    <div class="restock-drawer" *ngIf="restockOpen">
      <div class="restock-header">
        <div>
          <div class="restock-title">Restock Suggestions</div>
          <div class="restock-subtitle">
            {{ restockSummary.lowBoxes }} boxes · {{ restockSummary.totalSuggested }} units
          </div>
        </div>
        <button type="button" class="close-btn" (click)="closeRestock()">Close</button>
      </div>
      <div class="restock-body">
        <div
          class="restock-row"
          *ngFor="let item of restockItems"
          (click)="focusRestockItem(item.id)"
        >
          <div class="restock-name">{{ item.name }}</div>
          <div class="restock-meta">{{ item.tag }}</div>
          <div class="restock-stats">
            <span>Stock {{ item.total }}</span>
            <span>Min {{ item.min }}</span>
            <span *ngIf="item.max">Max {{ item.max }}</span>
          </div>
          <div class="restock-suggest">+{{ item.suggested }}</div>
        </div>
        <div class="restock-empty" *ngIf="restockItems.length === 0">
          No low-stock boxes found.
        </div>
      </div>
    </div>
    <div class="direction-compass" aria-label="Direction compass">
      <div class="compass-ring"></div>
      <div class="compass-label north">N</div>
      <div class="compass-label east">E</div>
      <div class="compass-label south">S</div>
      <div class="compass-label west">W</div>
    </div>
    <div class="heatmap-legend" *ngIf="heatmapEnabled">
      <span><i class="heatmap-swatch" style="background:#3b82f6"></i>Empty</span>
      <span><i class="heatmap-swatch" style="background:#10b981"></i>Low</span>
      <span><i class="heatmap-swatch" style="background:#f59e0b"></i>Mid</span>
      <span><i class="heatmap-swatch" style="background:#ef4444"></i>High</span>
      <span><i class="heatmap-swatch" style="background:#b91c1c"></i>Over</span>
    </div>
  </div>
</div>
